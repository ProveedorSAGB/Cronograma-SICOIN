<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Actividades SICOIN - Control de Avances</title>
    <style>
        :root {
            --primary-dark: #621333;
            --primary-green: #002F2A;
            --primary-gold: #A6802D;
            --primary-dark-light: #8B1E4A;
            --primary-green-light: #004740;
            --primary-gold-light: #C49A3A;
            --bg-gradient: linear-gradient(135deg, #621333 0%, #002F2A 50%, #A6802D 100%);
            --text-light: #FFFFFF;
            --text-dark: #333333;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            animation: slideInDown 0.8s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header h1 {
            color: var(--primary-dark);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: var(--primary-green);
            font-size: 1.2em;
            font-weight: 600;
        }

        .progress-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .progress-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .progress-card h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .progress-ring .bg {
            stroke: #e0e0e0;
        }

        .progress-ring .progress {
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring .progress-1 { stroke: var(--primary-dark); }
        .progress-ring .progress-2 { stroke: var(--primary-green); }
        .progress-ring .progress-3 { stroke: var(--primary-gold); }
        .progress-ring .progress-4 { stroke: var(--primary-dark-light); } /* New color for Actividad 4 */


        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .activities-container {
            display: grid;
            gap: 30px;
        }

        .activity-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border-left: 8px solid var(--primary-dark);
            animation: slideInLeft 0.8s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .activity-card:nth-child(2) {
            border-left-color: var(--primary-green);
            animation-delay: 0.2s;
        }

        .activity-card:nth-child(3) {
            border-left-color: var(--primary-gold);
            animation-delay: 0.4s;
        }

        .activity-card:nth-child(4) { /* New style for Actividad 4 */
            border-left-color: var(--primary-dark-light);
            animation-delay: 0.6s;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .activity-title {
            font-size: 1.8em;
            color: var(--primary-dark);
            font-weight: bold;
        }

        .activity-status {
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            color: white;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-select {
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid var(--primary-dark);
            background-color: white;
            font-weight: bold;
            color: var(--primary-dark);
            cursor: pointer;
            appearance: none; /* Remove default select arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23621333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }

        .status-iniciado { background: var(--primary-gold); }
        .status-pendiente { background: var(--primary-green); }
        .status-planificado { background: var(--primary-dark); }
        .status-completado { background: #28a745; } /* Green for completed */


        .activity-description {
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .task-item {
            background: rgba(98, 19, 51, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .task-item:hover {
            border-color: var(--primary-dark);
            transform: scale(1.02);
        }

        .task-item.completed {
            background: rgba(0, 47, 42, 0.1);
            border-color: var(--primary-green);
        }

        .task-item.in-progress {
            background: rgba(166, 128, 45, 0.1);
            border-color: var(--primary-gold);
        }

        .task-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .task-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .task-title {
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }

        .task-description {
            font-size: 0.9em;
            color: var(--text-dark);
            opacity: 0.8;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-green), var(--primary-gold));
            transition: width 0.5s ease;
            border-radius: 10px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 47, 42, 0.05);
            border-radius: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .timeline-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .timeline-date {
            font-weight: bold;
            color: var(--primary-green);
            font-size: 1.1em;
        }

        .timeline-label {
            color: var(--text-dark);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .legal-framework {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: var(--shadow);
            border-left: 8px solid var(--primary-gold);
        }

        .legal-framework h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .legal-framework ul {
            list-style: none;
            padding: 0;
        }

        .legal-framework li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(98, 19, 51, 0.1);
            color: var(--text-dark);
        }

        .legal-framework li:last-child {
            border-bottom: none;
        }

        .activity-buttons { /* Renamed from update-buttons for clarity */
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: flex-end; /* Align buttons to the right */
        }

        .task-buttons { /* New class for task-level buttons */
            display: none; /* Hide task-level buttons */
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .btn-primary {
            background: var(--primary-dark);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(98, 19, 51, 0.3);
        }

        .btn-secondary {
            background: var(--primary-green);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--primary-green-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 47, 42, 0.3);
        }

        .btn-tertiary {
            background: var(--primary-gold);
            color: white;
        }

        .btn-tertiary:hover {
            background: var(--primary-gold-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(166, 128, 45, 0.3);
        }

        .export-section {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .export-section h3 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }

        .floating-btn.save {
            background: var(--primary-green);
        }

        .floating-btn.export {
            background: var(--primary-gold);
        }

        .floating-btn.settings {
            background: var(--primary-dark);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .activity-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .timeline {
                flex-direction: column;
                gap: 20px;
            }
            
            .floating-actions {
                bottom: 20px;
                right: 20px;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--primary-green);
        }

        .notification.info {
            background: var(--primary-gold);
        }
        .notification.error {
            background: #dc3545; /* Red color for errors */
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1002; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
        }

        .modal-content textarea {
            width: calc(100% - 20px);
            height: 100px;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            resize: vertical;
        }

        .modal-content input[type="password"],
        .modal-content input[type="file"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .modal-content .btn {
            margin: 5px;
        }

        .comments-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            text-align: left;
        }

        .comments-section h4 {
            color: var(--primary-green);
            margin-bottom: 10px;
        }

        .comment-item {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #eee;
        }

        .comment-item strong {
            color: var(--primary-dark);
        }

        .file-list {
            text-align: left;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .file-list a {
            display: block;
            padding: 8px 0;
            color: var(--primary-dark);
            text-decoration: none;
            border-bottom: 1px dashed #eee;
        }

        .file-list a:hover {
            color: var(--primary-green);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏛️ SICOIN - Sistema de Control Interno</h1>
            <p>Cronograma de Actividades de Consolidación de Bases de Datos</p>
            <p style="margin-top: 10px; font-size: 1em; color: var(--primary-gold);">
                Dirigido a: <strong>Lic. Guisel Alexandra Donato</strong><br>
                Proveedor: <strong>SAGB José Cruz Gómez número de contrato DC-625-2025</strong>
            </p>
        </div>

        <div class="progress-overview">
            <!-- Actividad 1 -->
            <div class="progress-card" data-activity-id="1">
                <h3>Actividad 1: Consolidación de Datos Históricos</h3>
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="56" cy="56" r="52"></circle>
                        <circle class="progress progress-1" cx="56" cy="56" r="52" stroke-dasharray="327" stroke-dashoffset="327"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
                <p>Perfilamiento y Consolidación de Datos Históricos</p>
            </div>
            <!-- Actividad 2 -->
            <div class="progress-card" data-activity-id="2">
                <h3>Actividad 2: Análisis Integral y Mejoras</h3>
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="56" cy="56" r="52"></circle>
                        <circle class="progress progress-2" cx="56" cy="56" r="52" stroke-dasharray="327" stroke-dashoffset="327"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
                <p>Análisis Integral del SICOIN y Propuesta de Mejoras</p>
            </div>
            <!-- Actividad 3 -->
            <div class="progress-card" data-activity-id="3">
                <h3>Actividad 3: Propuesta de Reportes Nuevos</h3>
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="56" cy="56" r="52"></circle>
                        <circle class="progress progress-3" cx="56" cy="56" r="52" stroke-dasharray="327" stroke-dashoffset="327"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
                <p>Diseño de Nuevos Reportes para el SICOIN</p>
            </div>
            <!-- Actividad 4 -->
            <div class="progress-card" data-activity-id="4">
                <h3>Actividad 4: Gestión de Claves de Usuario</h3>
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="56" cy="56" r="52"></circle>
                        <circle class="progress progress-4" cx="56" cy="56" r="52" stroke-dasharray="327" stroke-dashoffset="327"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
                <p>Consolidación y Optimización de Claves de Usuario</p>
            </div>
        </div>

        <div class="activities-container">
             <!-- Actividad 1 -->
            <div class="activity-card" data-activity-id="1">
                <div class="activity-header">
                    <h2 class="activity-title">📊 Actividad 1: Perfilamiento y Consolidación de los Datos Históricos de Control Interno</h2>
                    <select class="status-select" data-activity-id="1">
                        <option value="Planificado">Planificado</option>
                        <option value="Iniciado">Iniciado</option>
                        <option value="Completado">Completado</option>
                    </select>
                </div>
                <div class="activity-description">
                    <strong>Objetivo:</strong> Recopilar, perfilar y consolidar la información histórica derivada de la implementación y evaluación del Sistema de Control Interno (SCI) en cada una de las entidades que conforman la APF, correspondiente a los ejercicios fiscales de 2014 a 2017, registrada en el SICOIN y disponible a través de los reportes del Programa de Trabajo de Administración de Riesgos (PTAR) y del Programa de Trabajo de Control Interno (PTCI).
                </div>
                <div class="tasks-grid">
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="0"><span class="task-title">Tarea 0: Recopilar e integrar la información en una base de datos principal denominada “Histórico PTCI y PTAR 2017–2024”.</span></div><div class="task-description">Se recopilará e integrará la información disponible mediante los reportes del SICOIN (PTCI, PTAR, PTCI_Desglosado y PTAR_Desglosado), concentrándola en un solo archivo que servirá como base de datos fundamental para el análisis histórico.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="1"><span class="task-title">Tarea 1: Perfilamiento de la base de datos y resectorización conforme al PEF.</span></div><div class="task-description">Se realizará un diagnóstico inicial del estado de los datos consolidados. Como parte del perfilamiento, también se actualizarán los nombres oficiales de las instituciones y se asignará a cada una el sector correspondiente conforme al Presupuesto de Egresos de la Federación (PEF) del ejercicio más reciente.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="2"><span class="task-title">Tarea 2: Depuración y consolidación técnica de la base de datos final.</span></div><div class="task-description">Se llevará a cabo una limpieza profunda de la base de datos perfilada, eliminando registros duplicados, inconsistencias, datos incompletos o irrelevantes (registros basura) y cualquier otro elemento que afecte la calidad del conjunto. Posteriormente, se consolidará la base de datos depurada para dejarla en condiciones óptimas para análisis e interpretación.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="3"><span class="task-title">Tarea 3: Obtención de cifras históricas globales inamovibles.</span></div><div class="task-description">A partir de la base de datos depurada y consolidada, se obtendrán las cifras históricas globales correspondientes a las acciones de control, acciones de mejora, riesgos identificados y factores de riesgo, junto con su estatus respectivo (atendido, en proceso, no atendido, etc.). Estas cifras servirán como indicadores inamovibles de referencia institucional, permitiendo la generación de reportes comparativos, análisis de evolución del SCI y construcción de tableros de seguimiento confiables.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="4"><span class="task-title">Tarea 4: Realizar Informe Técnico de Resultados.</span></div><div class="task-description">Se elaborará un informe técnico final dirigido al área de Sistemas, en el que se detallarán los resultados del proceso de depuración, perfilamiento y consolidación de la base de datos histórica del SCI. El informe incluirá una relación precisa de los registros que deberán eliminarse o corregirse en la base original del sistema, con el objetivo de asegurar la integridad, consistencia y actualización de la información contenida en SICOIN.</div>
                    </div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                <div class="timeline">
                    <div class="timeline-item"><div class="timeline-date">Día 1-2</div><div class="timeline-label">Recopilar e Integrar Base de Datos</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 3-5</div><div class="timeline-label">Perfilamiento y Resectorización</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 6-12</div><div class="timeline-label">Depuración y Consolidación</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 13-14</div><div class="timeline-label">Obtención de Cifras Históricas</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 15-16</div><div class="timeline-label">Informe Técnico de Resultados</div></div>
                    <div class="timeline-item"><div class="timeline-date">10 Julio 2025</div><div class="timeline-label">Entrega Final</div></div>
                </div>
                <div class="activity-buttons">
                    <button class="btn btn-primary" onclick="uploadFilePrompt(1)">Cargar Archivo</button>
                    <button class="btn btn-secondary" onclick="downloadFile(1)">Descargar Avance</button>
                    <button class="btn btn-tertiary" data-activity-id="1" onclick="addComment(1)">Añadir Comentario</button>
                </div>
            </div>
            <!-- Actividad 2 -->
            <div class="activity-card" data-activity-id="2">
                <div class="activity-header">
                    <h2 class="activity-title">🔍 Actividad 2: Análisis Integral del SICOIN y Propuesta de Mejoras</h2>
                    <select class="status-select" data-activity-id="2">
                        <option value="Planificado">Planificado</option>
                        <option value="Iniciado">Iniciado</option>
                        <option value="Completado">Completado</option>
                    </select>
                </div>
                <div class="activity-description">
                    <strong>Objetivo:</strong> Realizar un análisis exhaustivo del sistema SICOIN para identificar variables críticas, proponer nuevos reportes, optimizar visualizaciones de datos y establecer criterios de normalización institucional conforme a las Disposiciones Generales de Control Interno.
                </div>
                <div class="tasks-grid">
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="0"><span class="task-title">Tarea 0: Identificación de variables críticas del sistema.</span></div><div class="task-description">Se llevará a cabo una revisión integral de las bases de datos y reportes del sistema SICOIN con el objetivo de identificar variables clave para el análisis institucional, tales como los riesgos, acciones de control, acciones de mejora y factores de riesgo. Este análisis permitirá detectar oportunidades de mejora en la estructura de información del sistema y sentará las bases para la redefinición de reportes y dashboards.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="1"><span class="task-title">Tarea 1: Propuesta de rediseño y ampliación de reportes institucionales.</span></div><div class="task-description">Se desarrollará una propuesta técnica para rediseñar los reportes existentes del sistema SICOIN, incorporando variables adicionales que actualmente no están consideradas y cuya inclusión facilitaría el análisis estratégico de control interno y administración de riesgos. Los nuevos reportes estarán alineados con las necesidades operativas de los usuarios y con las mejores prácticas de gestión pública.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="2"><span class="task-title">Tarea 2: Optimización de visualización de módulos y dashboards.</span></div><div class="task-description">Se elaborará una propuesta de mejora visual para los módulos del sistema, incluyendo pestañas, secciones, cuadros de mando y dashboards. Se buscará mejorar la experiencia del usuario mediante una organización más clara de la información, una jerarquía visual más eficiente y una mayor facilidad de navegación entre reportes.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="3"><span class="task-title">Tarea 3: Depuración y actualización de módulos obsoletos.</span></div><div class="task-description">Se realizará una revisión técnica para identificar secciones, funcionalidades o módulos que hayan quedado en desuso, sean redundantes o hayan perdido vigencia normativa. A partir de este análisis, se propondrá su eliminación o reestructuración, con el fin de simplificar el sistema y mantenerlo alineado con las funciones actuales del SCI.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="4"><span class="task-title">Tarea 4: Elaboración de la Propuesta Final de Actualización del SICOIN.</span></div><div class="task-description">Se integrará un análisis técnico final que consolide los hallazgos, mejoras propuestas y observaciones derivadas de las tareas anteriores. Este documento incluirá una revisión estructurada por módulo del sistema y por tipo de reporte, detallando para cada uno: el diagnóstico actual, las áreas de mejora identificadas, las sugerencias específicas de rediseño o depuración, y las recomendaciones normativas aplicables. La propuesta se presentará en un archivo final denominado “Propuesta de Actualización y Mejora del Sistema SICOIN”, el cual servirá como insumo técnico para la toma de decisiones en el rediseño funcional del sistema.</div>
                    </div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                <div class="timeline">
                    <div class="timeline-item"><div class="timeline-date">Día 1</div><div class="timeline-label">Identificación de Variables Críticas</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 2</div><div class="timeline-label">Propuesta de Nuevos Reportes</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 3</div><div class="timeline-label">Optimización de Visualizaciones y Depuración de Módulos</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 4</div><div class="timeline-label">Propuesta de normalización e Informe final</div></div>
                    <div class="timeline-item"><div class="timeline-date">15 Julio 2025</div><div class="timeline-label">Entrega Final</div></div>
                </div>
                <div class="activity-buttons">
                    <button class="btn btn-primary" onclick="uploadFilePrompt(2)">Cargar Archivo</button>
                    <button class="btn btn-secondary" onclick="downloadFile(2)">Descargar Avance</button>
                    <button class="btn btn-tertiary" data-activity-id="2" onclick="addComment(2)">Añadir Comentario</button>
                </div>
            </div>
            <!-- Actividad 3 -->
            <div class="activity-card" data-activity-id="3">
                <div class="activity-header">
                    <h2 class="activity-title">👥 Actividad 3: Propuesta de Reportes Nuevos para el SICOIN</h2>
                    <select class="status-select" data-activity-id="3">
                        <option value="Planificado">Planificado</option>
                        <option value="Iniciado">Iniciado</option>
                        <option value="Completado">Completado</option>
                    </select>
                </div>
                <div class="activity-description">
                    <strong>Objetivo:</strong> Diseñar una propuesta integral de nuevos reportes institucionales a partir de la base de datos consolidada en la Actividad 1, mediante una aplicación auxiliar denominada SICOIN Dashboard, que servirá como entorno de visualización y validación para los reportes que se propondrán para su futura implementación dentro del sistema SICOIN.
                </div>
                <div class="tasks-grid">
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="0"><span class="task-title">Tarea 0: Análisis de variables clave y diseño de estructura de reportes.</span></div><div class="task-description">Se realizará un análisis de la base de datos consolidada (PTCI y PTAR 2017–2024) con el objetivo de definir las variables más relevantes para la construcción de reportes institucionales. A partir de ello, se diseñará una estructura base de reportes alineada con las necesidades de seguimiento del SCI, agrupando información por tipo de acción, estatus, institución, sector y temporalidad.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="1"><span class="task-title">Tarea 1: Desarrollo del entorno auxiliar “SICOIN Dashboard”.</span></div><div class="task-description">Se habilitará una aplicación de visualización externa denominada SICOIN Dashboard, que utilizará como fuente la base de datos consolidada. Esta aplicación permitirá cargar, visualizar y validar el funcionamiento de los reportes propuestos, así como presentar un modelo funcional del comportamiento esperado de los futuros reportes en SICOIN.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="2"><span class="task-title">Tarea 2: Construcción de reportes en SICOIN Dashboard.</span></div><div class="task-description">Se desarrollarán en el entorno SICOIN Dashboard los reportes propuestos, con énfasis en la claridad visual, relevancia operativa y utilidad institucional. Los reportes incluirán vistas por entidad, sector, avance de acciones de control, evolución de riesgos y cumplimiento del SCI, entre otros indicadores clave. Cada reporte contará con filtros dinámicos, campos calculados y opciones de exportación.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="3"><span class="task-title">Tarea 3: Validación funcional y retroalimentación interna.</span></div><div class="task-description">Los reportes desarrollados en el Dashboard serán presentados a los usuarios clave del sistema para su validación funcional. A partir de la retroalimentación obtenida, se harán los ajustes necesarios para mejorar su estructura, claridad e interpretación de datos, asegurando su viabilidad para integración en SICOIN.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="4"><span class="task-title">Tarea 4: Informe técnico de propuesta de reportes nuevos para SICOIN.</span></div><div class="task-description">Se elaborará un informe técnico con la propuesta final de reportes nuevos a integrar en el SICOIN, incluyendo capturas de pantalla, descripciones técnicas, objetivos de cada reporte, variables utilizadas, reglas de cálculo, filtros aplicables y recomendaciones para su implementación técnica en el sistema. El archivo se titulará “Propuesta de Nuevos Reportes Institucionales para SICOIN”.</div>
                    </div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                <div class="timeline">
                    <div class="timeline-item"><div class="timeline-date">Día 1</div><div class="timeline-label">Análisis de variables y diseño de estructura de reportes</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 2</div><div class="timeline-label">Construcción de Reportes</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 3</div><div class="timeline-label">Validación Funcional y Retroalimentación</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 4</div><div class="timeline-label">Informe Técnico de Propuesta Final y Power Point Correspondiente</div></div>
                    <div class="timeline-item"><div class="timeline-date">21 Julio 2025</div><div class="timeline-label">Entrega Final</div></div>
                </div>
                <div class="activity-buttons">
                    <button class="btn btn-primary" onclick="uploadFilePrompt(3)">Cargar Archivo</button>
                    <button class="btn btn-secondary" onclick="downloadFile(3)">Descargar Avance</button>
                    <button class="btn btn-tertiary" data-activity-id="3" onclick="addComment(3)">Añadir Comentario</button>
                </div>
            </div>
            <!-- Actividad 4 -->
            <div class="activity-card" data-activity-id="4">
                <div class="activity-header">
                    <h2 class="activity-title">👥 Actividad 4: Gestión y Consolidación de Claves de Usuario del SICOIN</h2>
                    <select class="status-select" data-activity-id="4">
                        <option value="Planificado">Planificado</option>
                        <option value="Iniciado">Iniciado</option>
                        <option value="Completado">Completado</option>
                    </select>
                </div>
                <div class="activity-description">
                    <strong>Objetivo:</strong> Consolidar y optimizar la administración de claves de usuario en el sistema SICOIN, mediante una auditoría integral de accesos vigentes, la depuración de claves inválidas, la unificación de perfiles y la implementación de controles de acceso más robustos, en cumplimiento con las disposiciones de seguridad informática institucional.
                </div>
                <div class="tasks-grid">
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="4" data-task-id="0"><span class="task-title">Tarea 0: Auditoría de claves activas en el sistema.</span></div><div class="task-description">Se realizará una revisión integral de los usuarios con acceso vigente al SICOIN, identificando el número de claves activas por entidad, tipo de perfil, fechas de última conexión y correspondencia con los titulares o responsables operativos del sistema.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="4" data-task-id="1"><span class="task-title">Tarea 1: Identificación de claves inválidas o inactivas.</span></div><div class="task-description">Se detectarán claves asignadas a usuarios que ya no laboran en las entidades, aquellas que no han sido utilizadas en periodos prolongados o que presentan inconsistencias con el cargo o funciones institucionales asignadas.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="4" data-task-id="2"><span class="task-title">Tarea 2: Proceso de baja controlada de claves no válidas.</span></div><div class="task-description">Se implementará un procedimiento técnico y documentado para dar de baja las claves identificadas como inválidas, asegurando el resguardo de información relacionada y evitando afectaciones a la operación regular del sistema.</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="4" data-task-id="3"><span class="task-title">Tarea 3: Consolidación y homologación de perfiles de usuario.</span></div><div class="task-description">Se llevará a cabo un proceso de revisión y estandarización de los perfiles existentes en SICOIN, agrupando y optimizando los niveles de acceso conforme a las funciones reales desempeñadas por cada tipo de usuario (captura, validación, consulta, administrador, etc.).</div>
                    </div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="4" data-task-id="4"><span class="task-title">Tarea 4: Implementación de nuevos controles de acceso.</span></div><div class="task-description">Se propondrán e implementarán mecanismos adicionales de seguridad institucional, como validación periódica de usuarios activos, revisión semestral de perfiles, doble autenticación, y alertas automáticas para accesos inusuales o no autorizados.</div>
                    </div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                <div class="timeline">
                    <div class="timeline-item"><div class="timeline-date">Día 1</div><div class="timeline-label">Auditoría de claves activas</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 2</div><div class="timeline-label">Identificación de claves inválidas</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 3</div><div class="timeline-label">Proceso de baja controlada</div></div>
                    <div class="timeline-item"><div class="timeline-date">Día 4</div><div class="timeline-label">Consolidación de perfiles e implementación de controles de acceso</div></div>
                    <div class="timeline-item"><div class="timeline-date">25 Julio 2025</div><div class="timeline-label">Entrega Final</div></div>
                </div>
                <div class="activity-buttons">
                    <button class="btn btn-primary" onclick="uploadFilePrompt(4)">Cargar Archivo</button>
                    <button class="btn btn-secondary" onclick="downloadFile(4)">Descargar Avance</button>
                    <button class="btn btn-tertiary" data-activity-id="4" onclick="addComment(4)">Añadir Comentario</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Modal para Comentarios -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('commentModal')">&times;</span>
            <h3>Añadir Comentario</h3>
            <textarea id="commentText" placeholder="Escribe tu comentario aquí..."></textarea>
            <button class="btn btn-primary" id="saveCommentBtn">Guardar Comentario</button>
            <div class="comments-section" id="commentsList">
                <h4>Comentarios Anteriores:</h4>
                <!-- Los comentarios se cargarán aquí -->
            </div>
        </div>
    </div>

    <!-- Modal para Carga de Archivos -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('uploadModal')">&times;</span>
            <h3>Cargar Archivo de Avance</h3>
            <input type="password" id="uploadPassword" placeholder="Contraseña">
            <input type="file" id="fileInput">
            <button class="btn btn-primary" id="confirmUploadBtn">Confirmar Carga</button>
        </div>
    </div>

    <!-- Modal para Descarga de Archivos -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('downloadModal')">&times;</span>
            <h3>Archivos de Avance</h3>
            <div class="file-list" id="filesList">
                <!-- Los archivos se cargarán aquí -->
            </div>
        </div>
    </div>

    <!-- SCRIPT DE FIREBASE -->
    <script type="module">
      // --- 1. INICIALIZACIÓN DE FIREBASE ---
      // Importamos las funciones necesarias de los SDK de Firebase.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
      import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

      // --- CONFIGURACIÓN DE FIREBASE ---
      // Esta es la configuración de tu proyecto de Firebase.
      const firebaseConfig = {
        apiKey: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config).apiKey : "YOUR_FIREBASE_API_KEY", // Usar __firebase_config si está disponible
        authDomain: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config).authDomain : "YOUR_FIREBASE_AUTH_DOMAIN",
        projectId: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config).projectId : "YOUR_FIREBASE_PROJECT_ID",
        storageBucket: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config).storageBucket : "YOUR_FIREBASE_STORAGE_BUCKET",
        messagingSenderId: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config).messagingSenderId : "YOUR_FIREBASE_MESSAGING_SENDER_ID",
        appId: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config).appId : "YOUR_FIREBASE_APP_ID"
      };

      // Define un ID único para tu aplicación basado en el projectId de Firebase.
      const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
      console.log("App ID utilizada para Firestore:", appId); // Para depuración

      // Validar que la configuración de Firebase tenga una API Key
      if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY") {
          console.error("Firebase Error: La clave API no está definida en la configuración de Firebase o es un placeholder.");
          mostrarNotificacion("Error: Clave API de Firebase no configurada. Consulta la consola.", "error");
      }

      // Inicializamos la aplicación de Firebase.
      const app = initializeApp(firebaseConfig);
      // Obtenemos las instancias de Autenticación, Firestore y Storage.
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // --- 2. ESTADO GLOBAL Y REFERENCIA A FIRESTORE ---
      // Referencia al documento único que almacenará todo el estado del cronograma.
      const progressDocRef = doc(db, "artifacts", appId, "public", "data", "Avance", "estadoCronograma");

      // Objeto que mantendrá el estado actual del progreso en la memoria del navegador.
      let cronogramaState = {
          actividades: {
              '1': { progreso: 0, tareas: [false, false, false, false, false], status: 'Planificado', comments: [], files: [] }, // files is now an array
              '2': { progreso: 0, tareas: [false, false, false, false, false], status: 'Planificado', comments: [], files: [] },
              '3': { progreso: 0, tareas: [false, false, false, false, false], status: 'Planificado', comments: [], files: [] },
              '4': { progreso: 0, tareas: [false, false, false, false, false], status: 'Planificado', comments: [], files: [] }
          }
      };
      
      let isSaving = false; // Flag para evitar guardados múltiples simultáneos
      let currentActivityId = null; // Used for comments and files

      // --- 3. AUTENTICACIÓN Y CARGA DE DATOS ---
      // onAuthStateChanged se ejecuta cuando el usuario inicia sesión o la página se carga.
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Si el usuario está autenticado.
          console.log("Usuario autenticado:", user.uid);
          
          // Escuchamos cambios en tiempo real en el documento de Firestore.
          // onSnapshot se ejecutará cada vez que los datos cambien en el servidor.
          onSnapshot(progressDocRef, (docSnap) => {
            if (docSnap.exists()) {
              // Si el documento existe, actualizamos nuestro estado local.
              console.log("Datos cargados desde Firestore:", docSnap.data());
              const loadedState = docSnap.data();
              // Merge loaded state with default to ensure all new fields are present
              for (const activityId in cronogramaState.actividades) {
                  if (loadedState.actividades[activityId]) {
                      // Ensure comments and files are initialized as objects/arrays if they don't exist in loadedState
                      cronogramaState.actividades[activityId] = {
                          ...cronogramaState.actividades[activityId],
                          ...loadedState.actividades[activityId],
                          comments: loadedState.actividades[activityId].comments || [], // Ensure comments is an array
                          files: loadedState.actividades[activityId].files || [] // Ensure files is an array
                      };
                  }
              }
            } else {
              // Si no existe, lo creamos con el estado inicial.
              console.log("No se encontró documento en Firestore. Creando uno nuevo.");
              // Se guarda el estado inicial para crear el documento en Firestore.
              guardarProgreso();
            }
            // Actualizamos la interfaz de usuario con los datos cargados o iniciales.
            actualizarUICompleta();
          }, (error) => {
              // Manejo de errores para el listener de snapshot
              console.error("Error en el listener de snapshot de Firestore:", error);
              mostrarNotificacion(`Error de Firestore: ${error.message}`, "error");
          });

        } else {
          // Si no hay usuario, intentamos iniciar sesión anónimamente.
          console.log("Intentando iniciar sesión anónimamente...");
          try {
              if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  // Only call signInWithCustomToken if the token is actually provided
                  await signInWithCustomToken(auth, __initial_auth_token);
              } else {
                  await signInAnonymously(auth);
              }
              console.log("Sesión iniciada anónimamente.");
          } catch (error) {
              console.error("Error en el inicio de sesión anónima:", error);
              mostrarNotificacion(`Error de autenticación: ${error.message}`, "error");
          }
        }
      });

      // --- 4. FUNCIONES PARA MANIPULAR EL ESTADO Y LA UI ---

      /**
       * Guarda el objeto `cronogramaState` completo en Firestore.
       * Se usa un "debounce" simple para evitar escrituras excesivas.
       */
      function guardarProgreso() {
          if (isSaving) return; // Si ya hay un guardado en proceso, no hacer nada.
          isSaving = true;
          
          // Se usa un setTimeout para agrupar múltiples cambios rápidos en un solo guardado.
          setTimeout(async () => {
              try {
                  // setDoc con { merge: true } actualiza el documento o lo crea si no existe.
                  await setDoc(progressDocRef, cronogramaState, { merge: true });
                  console.log("Progreso guardado en Firestore.");
                  mostrarNotificacion("Progreso guardado en la nube", "success");
              } catch (error) {
                  console.error("Error al guardar el progreso: ", error);
                  mostrarNotificacion(`Error al guardar: ${error.message}`, "error");
              } finally {
                  isSaving = false; // Liberamos el flag de guardado.
              }
          }, 1000); // Espera 1 segundo después del último cambio para guardar.
      }

      /**
       * Actualiza la interfaz de usuario (barras, círculos, checkboxes, estados)
       * para que refleje el estado actual de `cronogramaState`.
       */
      function actualizarUICompleta() {
          for (const activityId in cronogramaState.actividades) {
              const actividad = cronogramaState.actividades[activityId];
              const progreso = actividad.progreso;

              // Actualizar barra de progreso de la actividad
              const activityCard = document.querySelector(`.activity-card[data-activity-id="${activityId}"]`);
              if (activityCard) {
                  activityCard.querySelector('.progress-fill').style.width = `${progreso}%`;
                  // Actualizar checkboxes
                  const checkboxes = activityCard.querySelectorAll('.task-checkbox input');
                  actividad.tareas.forEach((estado, index) => {
                      if (checkboxes[index]) {
                          checkboxes[index].checked = estado;
                      }
                  });
                  // Actualizar estado de la actividad
                  const statusSelect = activityCard.querySelector('.status-select');
                  if (statusSelect) {
                      statusSelect.value = actividad.status;
                      statusSelect.className = `status-select status-${actividad.status.toLowerCase()}`;
                  }
              }

              // Actualizar círculo de progreso en la vista general
              const progressCard = document.querySelector(`.progress-card[data-activity-id="${activityId}"]`);
              if (progressCard) {
                  const circle = progressCard.querySelector('.progress');
                  const text = progressCard.querySelector('.progress-text');
                  if (circle) {
                    const radius = circle.r.baseVal.value;
                    const circumference = 2 * Math.PI * radius;
                    const offset = circumference - (progreso / 100) * circumference;
                    
                    circle.style.strokeDashoffset = offset;
                    text.textContent = `${progreso}%`;
                  }
              }
          }
      }

      /**
       * Se llama cuando se hace clic en un checkbox de una tarea.
       * @param {HTMLInputElement} checkbox - El elemento checkbox que se cambió.
       * @param {string} activityId - El ID de la actividad (1, 2, 3, 4).
       * @param {number} taskId - El índice de la tarea (empezando en 0).
       */
      function updateTask(checkbox, activityId, taskId) {
          // Actualizamos el estado de la tarea en nuestro objeto local.
          cronogramaState.actividades[activityId].tareas[taskId] = checkbox.checked;
          
          // Recalculamos el progreso de la actividad.
          const tareas = cronogramaState.actividades[activityId].tareas;
          const tareasCompletadas = tareas.filter(Boolean).length;
          const nuevoProgreso = Math.round((tareasCompletadas / tareas.length) * 100);
          cronogramaState.actividades[activityId].progreso = nuevoProgreso;

          // Actualizamos la UI y guardamos en Firestore.
          actualizarUICompleta();
          guardarProgreso();
      }

      /**
       * Se llama al cambiar el estado de una actividad.
       * @param {string} activityId - El ID de la actividad.
       * @param {string} newStatus - El nuevo estado ('Planificado', 'Iniciado', 'Completado').
       */
      function updateActivityStatus(activityId, newStatus) {
          cronogramaState.actividades[activityId].status = newStatus;
          actualizarUICompleta();
          guardarProgreso();
      }

      /**
       * Muestra una notificación temporal en la esquina de la pantalla.
       * @param {string} message - El mensaje a mostrar.
       * @param {string} type - 'success', 'info' o 'error' para el color.
       */
      function mostrarNotificacion(message, type) {
          const notification = document.getElementById('notification');
          notification.textContent = message;
          notification.className = `notification show ${type}`;
          setTimeout(() => {
              notification.className = 'notification';
          }, 3000); // La notificación desaparece después de 3 segundos.
      }

      /**
       * Abre un modal.
       * @param {string} modalId - El ID del modal a abrir.
       */
      function openModal(modalId) {
          document.getElementById(modalId).style.display = 'flex';
      }

      /**
       * Cierra un modal.
       * @param {string} modalId - El ID del modal a cerrar.
       */
      function closeModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
      }

      /**
       * Abre el modal de comentarios y carga los comentarios existentes para la actividad.
       * @param {string} activityId - El ID de la actividad.
       */
      async function addComment(activityId) {
          currentActivityId = activityId;
          openModal('commentModal');
          displayComments(activityId);
      }

      /**
       * Muestra los comentarios para una actividad específica.
       * @param {string} activityId - El ID de la actividad.
       */
      function displayComments(activityId) {
          const commentsListDiv = document.getElementById('commentsList');
          commentsListDiv.innerHTML = '<h4>Comentarios Anteriores:</h4>'; // Clear previous comments
          const comments = cronogramaState.actividades[activityId].comments || [];
          if (comments.length === 0) {
              commentsListDiv.innerHTML += '<p>No hay comentarios.</p>';
          } else {
              comments.forEach(comment => {
                  const commentItem = document.createElement('div');
                  commentItem.className = 'comment-item';
                  commentItem.innerHTML = `<strong>${comment.timestamp}:</strong> ${comment.text}`;
                  commentsListDiv.appendChild(commentItem);
              });
          }
      }

      /**
       * Guarda un comentario en Firestore.
       */
      document.getElementById('saveCommentBtn').addEventListener('click', () => {
          const commentText = document.getElementById('commentText').value;
          if (commentText.trim() === "") {
              mostrarNotificacion("El comentario no puede estar vacío.", "error");
              return;
          }
          const timestamp = new Date().toLocaleString();
          if (!cronogramaState.actividades[currentActivityId].comments) {
              cronogramaState.actividades[currentActivityId].comments = [];
          }
          cronogramaState.actividades[currentActivityId].comments.push({ text: commentText, timestamp: timestamp });
          document.getElementById('commentText').value = ''; // Clear textarea
          guardarProgreso();
          displayComments(currentActivityId); // Refresh comments in modal
          mostrarNotificacion("Comentario guardado.", "success");
      });

      /**
       * Abre el modal de carga de archivos y establece la actividad actual.
       * @param {string} activityId - El ID de la actividad.
       */
      function uploadFilePrompt(activityId) {
          currentActivityId = activityId;
          document.getElementById('uploadPassword').value = ''; // Clear password field
          document.getElementById('fileInput').value = ''; // Clear file input
          openModal('uploadModal');
      }

      /**
       * Confirma la carga del archivo después de verificar la contraseña.
       */
      document.getElementById('confirmUploadBtn').addEventListener('click', async () => {
          const password = document.getElementById('uploadPassword').value;
          const fileInput = document.getElementById('fileInput');
          const file = fileInput.files[0];

          if (password !== "admin") {
              mostrarNotificacion("Contraseña incorrecta.", "error");
              return;
          }
          if (!file) {
              mostrarNotificacion("Por favor, selecciona un archivo.", "error");
              return;
          }

          try {
              // Files are now stored at activity level, not task level
              const storageRef = ref(storage, `artifacts/${appId}/public/data/files/activity-${currentActivityId}/${file.name}`);
              await uploadBytes(storageRef, file);
              const fileURL = await getDownloadURL(storageRef);

              if (!cronogramaState.actividades[currentActivityId].files) {
                  cronogramaState.actividades[currentActivityId].files = [];
              }
              // Store file data in the activity's files array
              cronogramaState.actividades[currentActivityId].files.push({
                  name: file.name,
                  url: fileURL,
                  timestamp: new Date().toLocaleString()
              });
              guardarProgreso();
              mostrarNotificacion("Archivo cargado exitosamente.", "success");
              closeModal('uploadModal');
          } catch (error) {
              console.error("Error al cargar el archivo:", error);
              mostrarNotificacion(`Error al cargar el archivo: ${error.message}`, "error");
          }
      });

      /**
       * Abre el modal de descarga de archivos y lista los archivos disponibles para la actividad.
       * @param {string} activityId - El ID de la actividad.
       */
      async function downloadFile(activityId) {
          currentActivityId = activityId;
          openModal('downloadModal');
          displayFilesForDownload(activityId);
      }

      /**
       * Muestra los archivos disponibles para descargar en el modal.
       * @param {string} activityId - El ID de la actividad.
       */
      function displayFilesForDownload(activityId) {
          const filesListDiv = document.getElementById('filesList');
          filesListDiv.innerHTML = ''; // Clear previous files
          const files = cronogramaState.actividades[activityId].files || [];
          if (files.length === 0) {
              filesListDiv.innerHTML += '<p>No hay archivos para descargar en esta actividad.</p>';
          } else {
              files.forEach(file => {
                  const fileLink = document.createElement('a');
                  fileLink.href = file.url;
                  fileLink.target = '_blank'; // Open in new tab
                  fileLink.textContent = `${file.name} (${file.timestamp})`;
                  filesListDiv.appendChild(fileLink);
              });
          }
      }

      // Hacer las funciones globales para que puedan ser llamadas desde el HTML
      window.addComment = addComment;
      window.uploadFilePrompt = uploadFilePrompt;
      window.downloadFile = downloadFile;
      window.closeModal = closeModal;

      // --- 5. ADICIÓN DE LISTENERS DE EVENTOS DESPUÉS DE CARGAR EL DOM ---
      document.addEventListener('DOMContentLoaded', () => {
          // Adjuntar listeners para los checkboxes de tareas
          document.querySelectorAll('.task-checkbox input[type="checkbox"]').forEach(checkbox => {
              checkbox.addEventListener('change', (event) => {
                  const activityId = event.target.dataset.activityId;
                  const taskId = parseInt(event.target.dataset.taskId);
                  updateTask(event.target, activityId, taskId);
              });
          });

          // Adjuntar listeners para los select de estado de actividad
          document.querySelectorAll('.status-select').forEach(select => {
              select.addEventListener('change', (event) => {
                  const activityId = event.target.dataset.activityId;
                  const newStatus = event.target.value;
                  updateActivityStatus(activityId, newStatus);
              });
          });
      });
    </script>
</body>
</html>
