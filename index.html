<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Actividades SICOIN - Control de Avances</title>
    <style>
        :root {
            --primary-dark: #621333;
            --primary-green: #002F2A;
            --primary-gold: #A6802D;
            --primary-dark-light: #8B1E4A;
            --primary-green-light: #004740;
            --primary-gold-light: #C49A3A;
            --bg-gradient: linear-gradient(135deg, #621333 0%, #002F2A 50%, #A6802D 100%);
            --text-light: #FFFFFF;
            --text-dark: #333333;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            animation: slideInDown 0.8s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header h1 {
            color: var(--primary-dark);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: var(--primary-green);
            font-size: 1.2em;
            font-weight: 600;
        }

        .progress-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .progress-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .progress-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .progress-card h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }

        .progress-ring .bg {
            stroke: #e0e0e0;
        }

        .progress-ring .progress {
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring .progress-1 { stroke: var(--primary-dark); }
        .progress-ring .progress-2 { stroke: var(--primary-green); }
        .progress-ring .progress-3 { stroke: var(--primary-gold); }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .activities-container {
            display: grid;
            gap: 30px;
        }

        .activity-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border-left: 8px solid var(--primary-dark);
            animation: slideInLeft 0.8s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .activity-card:nth-child(2) {
            border-left-color: var(--primary-green);
            animation-delay: 0.2s;
        }

        .activity-card:nth-child(3) {
            border-left-color: var(--primary-gold);
            animation-delay: 0.4s;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .activity-title {
            font-size: 1.8em;
            color: var(--primary-dark);
            font-weight: bold;
        }

        .activity-status {
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            color: white;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-iniciado { background: var(--primary-gold); }
        .status-pendiente { background: var(--primary-green); }
        .status-planificado { background: var(--primary-dark); }

        .activity-description {
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .task-item {
            background: rgba(98, 19, 51, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .task-item:hover {
            border-color: var(--primary-dark);
            transform: scale(1.02);
        }

        .task-item.completed {
            background: rgba(0, 47, 42, 0.1);
            border-color: var(--primary-green);
        }

        .task-item.in-progress {
            background: rgba(166, 128, 45, 0.1);
            border-color: var(--primary-gold);
        }

        .task-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .task-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .task-title {
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }

        .task-description {
            font-size: 0.9em;
            color: var(--text-dark);
            opacity: 0.8;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-green), var(--primary-gold));
            transition: width 0.5s ease;
            border-radius: 10px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 47, 42, 0.05);
            border-radius: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .timeline-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .timeline-date {
            font-weight: bold;
            color: var(--primary-green);
            font-size: 1.1em;
        }

        .timeline-label {
            color: var(--text-dark);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .legal-framework {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: var(--shadow);
            border-left: 8px solid var(--primary-gold);
        }

        .legal-framework h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .legal-framework ul {
            list-style: none;
            padding: 0;
        }

        .legal-framework li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(98, 19, 51, 0.1);
            color: var(--text-dark);
        }

        .legal-framework li:last-child {
            border-bottom: none;
        }

        .update-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .btn-primary {
            background: var(--primary-dark);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(98, 19, 51, 0.3);
        }

        .btn-secondary {
            background: var(--primary-green);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--primary-green-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 47, 42, 0.3);
        }

        .btn-tertiary {
            background: var(--primary-gold);
            color: white;
        }

        .btn-tertiary:hover {
            background: var(--primary-gold-light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(166, 128, 45, 0.3);
        }

        .export-section {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .export-section h3 {
            color: var(--primary-dark);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }

        .floating-btn.save {
            background: var(--primary-green);
        }

        .floating-btn.export {
            background: var(--primary-gold);
        }

        .floating-btn.settings {
            background: var(--primary-dark);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .activity-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .timeline {
                flex-direction: column;
                gap: 20px;
            }
            
            .floating-actions {
                bottom: 20px;
                right: 20px;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--primary-green);
        }

        .notification.info {
            background: var(--primary-gold);
        }
        .notification.error {
            background: #dc3545; /* Red color for errors */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- El resto del HTML se mantiene igual -->
        <div class="header">
            <h1>üèõÔ∏è SICOIN - Sistema de Control Interno</h1>
            <p>Cronograma de Actividades de Consolidaci√≥n de Bases de Datos</p>
            <p style="margin-top: 10px; font-size: 1em; color: var(--primary-gold);">
                Dirigido a: <strong>Lic. Guisel Alexandra Donato</strong><br>
                Jefe(a) de Departamento de Prevenci√≥n de la Corrupci√≥n
            </p>
        </div>

        <div class="progress-overview">
            <!-- Actividad 1 -->
            <div class="progress-card" data-activity-id="1">
                <h3>Actividad 1: Consolidaci√≥n de Bases</h3>
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="56" cy="56" r="52"></circle>
                        <circle class="progress progress-1" cx="56" cy="56" r="52" stroke-dasharray="327" stroke-dashoffset="327"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
                <p>PTAR/PTCI vs PTAR_DESGLOSADO/PTCI_DESGLOSADO</p>
            </div>
            <!-- Actividad 2 -->
            <div class="progress-card" data-activity-id="2">
                <h3>Actividad 2: An√°lisis y Mejoras</h3>
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="56" cy="56" r="52"></circle>
                        <circle class="progress progress-2" cx="56" cy="56" r="52" stroke-dasharray="327" stroke-dashoffset="327"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
                <p>Revisi√≥n integral y propuestas de mejora</p>
            </div>
            <!-- Actividad 3 -->
            <div class="progress-card" data-activity-id="3">
                <h3>Actividad 3: Gesti√≥n de Usuarios</h3>
                <div class="progress-ring">
                    <svg>
                        <circle class="bg" cx="56" cy="56" r="52"></circle>
                        <circle class="progress progress-3" cx="56" cy="56" r="52" stroke-dasharray="327" stroke-dashoffset="327"></circle>
                    </svg>
                    <div class="progress-text">0%</div>
                </div>
                <p>Consolidaci√≥n y limpieza de claves de usuario</p>
            </div>
        </div>

        <div class="activities-container">
             <!-- Actividad 1 -->
            <div class="activity-card" data-activity-id="1">
                <div class="activity-header">
                    <h2 class="activity-title">üìä Actividad 1: Consolidaci√≥n de Bases de Datos Hist√≥ricas</h2>
                    <span class="activity-status status-iniciado">Iniciado</span>
                </div>
                <div class="activity-description">
                    <strong>Objetivo:</strong> Consolidar las bases de datos hist√≥ricas del SICOIN (PTAR y PTCI vs PTAR_DESGLOSADO y PTCI_DESGLOSADO) mediante resectorizaci√≥n, cruce de riesgos y consolidaci√≥n de acciones de control y mejora, conforme a las disposiciones de la Ley General del Sistema Nacional Anticorrupci√≥n.
                </div>
                <div class="tasks-grid">
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="0"><span class="task-title">Resectorizaci√≥n de Bases PTAR y PTCI</span></div><div class="task-description">Reorganizaci√≥n sectorial de las bases principales</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="1"><span class="task-title">Resectorizaci√≥n PTAR_DESGLOSADO</span></div><div class="task-description">Aplicaci√≥n de criterios de resectorizaci√≥n a base desglosada</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="2"><span class="task-title">Cruce de Riesgos en PTAR</span></div><div class="task-description">Identificaci√≥n y mapeo de riesgos entre bases</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="3"><span class="task-title">Consolidaci√≥n Acciones de Control</span></div><div class="task-description">Unificaci√≥n de acciones PTAR y PTAR_DESGLOSADO</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="4"><span class="task-title">Consolidaci√≥n Acciones de Mejora PTCI</span></div><div class="task-description">Armonizaci√≥n de acciones de mejora continua</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="5"><span class="task-title">Actualizaci√≥n SICOIN Dashboard</span></div><div class="task-description">Migraci√≥n de datos consolidados al sistema de visualizaci√≥n</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="1" data-task-id="6"><span class="task-title">Informe de Depuraci√≥n</span></div><div class="task-description">Documento t√©cnico con registros a eliminar de la base original</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                <div class="timeline">
                    <div class="timeline-item"><div class="timeline-date">D√≠a 1-2</div><div class="timeline-label">Resectorizaci√≥n</div></div>
                    <div class="timeline-item"><div class="timeline-date">D√≠a 3-4</div><div class="timeline-label">Cruce de Riesgos</div></div>
                    <div class="timeline-item"><div class="timeline-date">D√≠a 5-6</div><div class="timeline-label">Consolidaci√≥n</div></div>
                    <div class="timeline-item"><div class="timeline-date">D√≠a 7-8</div><div class="timeline-label">Dashboard</div></div>
                    <div class="timeline-item"><div class="timeline-date">D√≠a 9-10</div><div class="timeline-label">Informe</div></div>
                </div>
                <div class="update-buttons">
                    <button class="btn btn-primary" data-activity-id="1" data-amount="10">+10% Avance</button>
                    <button class="btn btn-secondary" data-activity-id="1" data-amount="25">+25% Avance</button>
                    <button class="btn btn-tertiary" data-activity-id="1" data-action="comment">A√±adir Comentario</button>
                </div>
            </div>
            <!-- Actividad 2 -->
            <div class="activity-card" data-activity-id="2">
                <div class="activity-header">
                    <h2 class="activity-title">üîç Actividad 2: An√°lisis Integral y Propuestas de Mejora</h2>
                    <span class="activity-status status-pendiente">Pendiente</span>
                </div>
                <div class="activity-description">
                    <strong>Objetivo:</strong> Realizar un an√°lisis exhaustivo del SICOIN para identificar variables cr√≠ticas, proponer nuevos reportes, optimizar visualizaciones de datos y establecer criterios de normalizaci√≥n institucional conforme a las Disposiciones Generales de Control Interno.
                </div>
                <div class="tasks-grid">
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="0"><span class="task-title">An√°lisis de Variables Cr√≠ticas</span></div><div class="task-description">Identificaci√≥n de variables que generan oportunidades de an√°lisis</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="1"><span class="task-title">Propuesta de Nuevos Reportes</span></div><div class="task-description">Dise√±o de reportes con variables adicionales no contempladas</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="2"><span class="task-title">Optimizaci√≥n de Visualizaciones</span></div><div class="task-description">Mejora de cuadros de mando y dashboards existentes</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="3"><span class="task-title">Depuraci√≥n de M√≥dulos</span></div><div class="task-description">Identificaci√≥n y retiro de secciones obsoletas</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="4"><span class="task-title">Investigaci√≥n Normativa</span></div><div class="task-description">Requisitos legales para normalizaci√≥n del SICOIN</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="2" data-task-id="5"><span class="task-title">Propuesta de Normalizaci√≥n</span></div><div class="task-description">Criterios obligatorios para carga institucional de datos</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                <div class="update-buttons">
                    <button class="btn btn-primary" data-activity-id="2" data-amount="10">+10% Avance</button>
                    <button class="btn btn-secondary" data-activity-id="2" data-amount="25">+25% Avance</button>
                    <button class="btn btn-tertiary" data-activity-id="2" data-action="comment">A√±adir Comentario</button>
                </div>
            </div>
            <!-- Actividad 3 -->
            <div class="activity-card" data-activity-id="3">
                <div class="activity-header">
                    <h2 class="activity-title">üë• Actividad 3: Gesti√≥n y Consolidaci√≥n de Usuarios</h2>
                    <span class="activity-status status-planificado">Planificado</span>
                </div>
                <div class="activity-description">
                    <strong>Objetivo:</strong> Consolidar y optimizar la gesti√≥n de claves de usuario del SICOIN, incluyendo la baja de claves inv√°lidas y la implementaci√≥n de controles de acceso mejorados, en cumplimiento con las disposiciones de seguridad inform√°tica institucional.
                </div>
                <div class="tasks-grid">
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="0"><span class="task-title">Auditor√≠a de Claves Activas</span></div><div class="task-description">Revisi√≥n integral de usuarios con acceso vigente</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="1"><span class="task-title">Identificaci√≥n de Claves Inv√°lidas</span></div><div class="task-description">Detecci√≥n de usuarios inactivos o con permisos obsoletos</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="2"><span class="task-title">Proceso de Baja de Usuarios</span></div><div class="task-description">Eliminaci√≥n controlada de accesos no v√°lidos</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="3"><span class="task-title">Consolidaci√≥n de Perfiles</span></div><div class="task-description">Unificaci√≥n y optimizaci√≥n de roles de usuario</div></div>
                    <div class="task-item"><div class="task-checkbox"><input type="checkbox" data-activity-id="3" data-task-id="4"><span class="task-title">Implementaci√≥n de Controles</span></div><div class="task-description">Nuevos mecanismos de seguridad y validaci√≥n</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                <div class="update-buttons">
                    <button class="btn btn-primary" data-activity-id="3" data-amount="10">+10% Avance</button>
                    <button class="btn btn-secondary" data-activity-id="3" data-amount="25">+25% Avance</button>
                    <button class="btn btn-tertiary" data-activity-id="3" data-action="comment">A√±adir Comentario</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- SCRIPT DE FIREBASE -->
    <script type="module">
      // --- 1. INICIALIZACI√ìN DE FIREBASE ---
      // Importamos las funciones necesarias de los SDK de Firebase.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      // La configuraci√≥n de Firebase se obtiene del entorno de Canvas.
      // Se utiliza un objeto vac√≠o como fallback si __firebase_config no est√° definido.
      const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

      // Validar que la configuraci√≥n de Firebase tenga una API Key
      if (!firebaseConfig || !firebaseConfig.apiKey) {
          console.error("Firebase Error: La clave API no est√° definida en la configuraci√≥n de Firebase. Aseg√∫rate de que __firebase_config est√© correctamente configurado en el entorno de Canvas.");
          mostrarNotificacion("Error: Clave API de Firebase no encontrada. Consulta la consola.", "error");
          // Detener la ejecuci√≥n si no hay una clave API v√°lida para evitar errores.
          throw new Error("Firebase API Key is missing.");
      }

      // Inicializamos la aplicaci√≥n de Firebase.
      const app = initializeApp(firebaseConfig);
      // Obtenemos las instancias de Autenticaci√≥n y Firestore.
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Obtenemos el ID de la aplicaci√≥n del entorno de Canvas.
      // Se utiliza 'default-app-id' como fallback si __app_id no est√° definido.
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // --- 2. ESTADO GLOBAL Y REFERENCIA A FIRESTORE ---
      // Referencia al documento √∫nico que almacenar√° todo el estado del cronograma.
      // La ruta sigue la estructura para datos p√∫blicos en Canvas:
      // /artifacts/{appId}/public/data/{nombre_coleccion}/{nombre_documento}
      const progressDocRef = doc(db, "artifacts", appId, "public", "data", "Avance", "estadoCronograma");

      // Objeto que mantendr√° el estado actual del progreso en la memoria del navegador.
      // Este es el estado inicial si no hay nada guardado en Firestore.
      let cronogramaState = {
          actividades: {
              '1': { progreso: 0, tareas: [false, false, false, false, false, false, false] },
              '2': { progreso: 0, tareas: [false, false, false, false, false, false] },
              '3': { progreso: 0, tareas: [false, false, false, false, false] }
          }
      };
      
      let isSaving = false; // Flag para evitar guardados m√∫ltiples simult√°neos

      // --- 3. AUTENTICACI√ìN Y CARGA DE DATOS ---
      // onAuthStateChanged se ejecuta cuando el usuario inicia sesi√≥n o la p√°gina se carga.
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Si el usuario est√° autenticado.
          console.log("Usuario autenticado:", user.uid);
          
          // Escuchamos cambios en tiempo real en el documento de Firestore.
          // onSnapshot se ejecutar√° cada vez que los datos cambien en el servidor.
          onSnapshot(progressDocRef, (docSnap) => {
            if (docSnap.exists()) {
              // Si el documento existe, actualizamos nuestro estado local.
              console.log("Datos cargados desde Firestore:", docSnap.data());
              cronogramaState = docSnap.data();
            } else {
              // Si no existe, lo creamos con el estado inicial.
              console.log("No se encontr√≥ documento en Firestore. Creando uno nuevo.");
              // Se guarda el estado inicial para crear el documento en Firestore.
              guardarProgreso();
            }
            // Actualizamos la interfaz de usuario con los datos cargados o iniciales.
            actualizarUICompleta();
          }, (error) => {
              // Manejo de errores para el listener de snapshot
              console.error("Error en el listener de snapshot de Firestore:", error);
              mostrarNotificacion(`Error de Firestore: ${error.message}`, "error");
          });

        } else {
          // Si no hay usuario, intentamos iniciar sesi√≥n con el token personalizado
          // proporcionado por el entorno de Canvas, o de forma an√≥nima si no est√° disponible.
          console.log("Intentando iniciar sesi√≥n...");
          try {
              if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await signInWithCustomToken(auth, __initial_auth_token);
                  console.log("Sesi√≥n iniciada con token personalizado.");
              } else {
                  await signInAnonymously(auth);
                  console.log("Sesi√≥n iniciada an√≥nimamente.");
              }
          } catch (error) {
              console.error("Error en el inicio de sesi√≥n:", error);
              mostrarNotificacion(`Error de autenticaci√≥n: ${error.message}`, "error");
          }
        }
      });

      // --- 4. FUNCIONES PARA MANIPULAR EL ESTADO Y LA UI ---

      /**
       * Guarda el objeto `cronogramaState` completo en Firestore.
       * Se usa un "debounce" simple para evitar escrituras excesivas.
       */
      function guardarProgreso() {
          if (isSaving) return; // Si ya hay un guardado en proceso, no hacer nada.
          isSaving = true;
          
          // Se usa un setTimeout para agrupar m√∫ltiples cambios r√°pidos en un solo guardado.
          setTimeout(async () => {
              try {
                  // setDoc con { merge: true } actualiza el documento o lo crea si no existe.
                  await setDoc(progressDocRef, cronogramaState, { merge: true });
                  console.log("Progreso guardado en Firestore.");
                  mostrarNotificacion("Progreso guardado en la nube", "success");
              } catch (error) {
                  console.error("Error al guardar el progreso: ", error);
                  mostrarNotificacion(`Error al guardar: ${error.message}`, "error");
              } finally {
                  isSaving = false; // Liberamos el flag de guardado.
              }
          }, 1000); // Espera 1 segundo despu√©s del √∫ltimo cambio para guardar.
      }

      /**
       * Actualiza la interfaz de usuario (barras, c√≠rculos, checkboxes)
       * para que refleje el estado actual de `cronogramaState`.
       */
      function actualizarUICompleta() {
          for (const activityId in cronogramaState.actividades) {
              const actividad = cronogramaState.actividades[activityId];
              const progreso = actividad.progreso;

              // Actualizar barra de progreso de la actividad
              const activityCard = document.querySelector(`.activity-card[data-activity-id="${activityId}"]`);
              if (activityCard) {
                  activityCard.querySelector('.progress-fill').style.width = `${progreso}%`;
                  // Actualizar checkboxes
                  const checkboxes = activityCard.querySelectorAll('.task-checkbox input');
                  actividad.tareas.forEach((estado, index) => {
                      if (checkboxes[index]) {
                          checkboxes[index].checked = estado;
                      }
                  });
              }

              // Actualizar c√≠rculo de progreso en la vista general
              const progressCard = document.querySelector(`.progress-card[data-activity-id="${activityId}"]`);
              if (progressCard) {
                  const circle = progressCard.querySelector('.progress');
                  const text = progressCard.querySelector('.progress-text');
                  // Asegurarse de que circle no sea null antes de acceder a r.baseVal.value
                  if (circle) {
                    const radius = circle.r.baseVal.value;
                    const circumference = 2 * Math.PI * radius;
                    const offset = circumference - (progreso / 100) * circumference;
                    
                    circle.style.strokeDashoffset = offset;
                    text.textContent = `${progreso}%`;
                  }
              }
          }
      }

      /**
       * Se llama cuando se hace clic en un checkbox de una tarea.
       * @param {HTMLInputElement} checkbox - El elemento checkbox que se cambi√≥.
       * @param {number} activityId - El ID de la actividad (1, 2, o 3).
       * @param {number} taskId - El √≠ndice de la tarea (empezando en 0).
       */
      function updateTask(checkbox, activityId, taskId) {
          // Actualizamos el estado de la tarea en nuestro objeto local.
          cronogramaState.actividades[activityId].tareas[taskId] = checkbox.checked;
          
          // Recalculamos el progreso de la actividad.
          const tareas = cronogramaState.actividades[activityId].tareas;
          const tareasCompletadas = tareas.filter(Boolean).length;
          const nuevoProgreso = Math.round((tareasCompletadas / tareas.length) * 100);
          cronogramaState.actividades[activityId].progreso = nuevoProgreso;

          // Actualizamos la UI y guardamos en Firestore.
          actualizarUICompleta();
          guardarProgreso();
      }

      /**
       * Se llama al presionar los botones de "+10% Avance" o "+25% Avance".
       * @param {number} activityId - El ID de la actividad.
       * @param {number} amount - La cantidad de progreso a a√±adir.
       */
      function updateProgress(activityId, amount) {
          let progresoActual = cronogramaState.actividades[activityId].progreso;
          progresoActual += amount;
          if (progresoActual > 100) progresoActual = 100; // No pasar del 100%
          
          cronogramaState.actividades[activityId].progreso = progresoActual;

          // Actualizamos la UI y guardamos.
          actualizarUICompleta();
          guardarProgreso();
      }

      /**
       * Muestra una notificaci√≥n temporal en la esquina de la pantalla.
       * @param {string} message - El mensaje a mostrar.
       * @param {string} type - 'success', 'info' o 'error' para el color.
       */
      function mostrarNotificacion(message, type) {
          const notification = document.getElementById('notification');
          notification.textContent = message;
          notification.className = `notification show ${type}`;
          setTimeout(() => {
              notification.className = 'notification';
          }, 3000); // La notificaci√≥n desaparece despu√©s de 3 segundos.
      }

      // Funciones placeholder que no interact√∫an con Firebase pero evitan errores.
      function addComment(activityId) {
          // En lugar de alert(), se podr√≠a implementar un modal personalizado.
          mostrarNotificacion(`Funci√≥n de comentario para Actividad ${activityId} no implementada.`, "info");
      }

      // --- 5. ADICI√ìN DE LISTENERS DE EVENTOS DESPU√âS DE CARGAR EL DOM ---
      document.addEventListener('DOMContentLoaded', () => {
          // Adjuntar listeners para los checkboxes de tareas
          document.querySelectorAll('.task-checkbox input[type="checkbox"]').forEach(checkbox => {
              checkbox.addEventListener('change', (event) => {
                  const activityId = event.target.dataset.activityId;
                  const taskId = parseInt(event.target.dataset.taskId);
                  updateTask(event.target, activityId, taskId);
              });
          });

          // Adjuntar listeners para los botones de avances
          document.querySelectorAll('.btn-primary, .btn-secondary').forEach(button => {
              button.addEventListener('click', (event) => {
                  const activityId = event.target.dataset.activityId;
                  const amount = parseInt(event.target.dataset.amount);
                  updateProgress(activityId, amount);
              });
          });

          // Adjuntar listeners para los botones de comentariossss
          document.querySelectorAll('.btn-tertiary').forEach(button => {
              button.addEventListener('click', (event) => {
                  const activityId = event.target.dataset.activityId;
                  addComment(activityId);
              });
          });
      });
    </script>
</body>
</html>
